# Feature Plan 0002 — Mapbox GL integration on Map page

**Context:** You want Mapbox wired to the Map tab so `/app/map` shows an interactive map instead of a placeholder. We will integrate Mapbox GL JS, load upcoming items (events + occurrences) as GeoJSON points, enable clustering and popups, and ensure sensible initial bounds.

---

## Scope Summary
- Install and configure Mapbox GL JS.
- Replace the Map placeholder in `src/routes/MapHome.tsx` with a real map.
- Load upcoming items (approved and not ended) and render as clustered points.
- Add popups linking to `/app/e/:slug` and controls for navigation/geolocate.

---

## Files to Change or Create
- `package.json`: add `mapbox-gl`; add `@types/mapbox-gl` as dev dependency.
- `.env.local`: add `VITE_MAPBOX_TOKEN` (ignored by git; used by Vite).
- `styles/global.css`: ensure the map container has a height; optionally import Mapbox CSS if desired.
- `src/routes/MapHome.tsx`: mount Mapbox map, render in a card, clean up on unmount.
- `src/lib/map.ts` (new): helpers to fetch/merge upcoming items and build GeoJSON; compute bounds.
- `src/components/MapboxMap.tsx` (optional new): encapsulate Mapbox lifecycle and props.

---

## PowerShell commands (Windows 11)
- Install dependencies:
  - `npm i mapbox-gl`
  - `npm i -D @types/mapbox-gl`
- Create env file with token:
  - `Set-Content -Path .env.local -Value "VITE_MAPBOX_TOKEN=pk.YOUR_MAPBOX_TOKEN_HERE"`
- Start dev server:
  - `npm run dev`

---

## Behavioral Details
- Initialization (in `MapHome` or a `MapboxMap` wrapper):
  - Read token from `import.meta.env.VITE_MAPBOX_TOKEN` and set `mapboxgl.accessToken`.
  - Create map with style `mapbox://styles/mapbox/dark-v11` (or your studio style), sensible default `center/zoom`.
  - Add `NavigationControl` (no compass) and `GeolocateControl`.
  - Clean up on unmount with `map.remove()`.
- Data plumbing (in `src/lib/map.ts`):
  - Fetch approved upcoming `events` and `occurrences`:
    - `where('status','==','approved')`, `where('endUTC','>=', nowISO)`, `orderBy('endUTC','asc')`, optional `limit(200)`.
  - Merge lists, sort by `startUTC` asc, filter out items without valid `lat/lng`.
  - Build GeoJSON FeatureCollection<Point> with useful `properties` (`id/slug`, `name`, `type`, `startUTC`, `endUTC`, `city`).
  - Compute bounds from features for `fitBounds`.
- Map layers (after `map.on('load')`):
  - `map.addSource('events', { type:'geojson', data, cluster:true, clusterRadius:50, clusterMaxZoom:14 })`.
  - Add three layers: cluster circles, cluster count symbols, unclustered points.
  - Interactions:
    - Click cluster → `getClusterExpansionZoom` then `easeTo({ center, zoom })`.
    - Click unclustered point → popup with name, local time range, city, and link to `/app/e/:slug`.
- Bounds behavior:
  - After first data load, if points exist, `fitBounds(bounds, { padding: 40, duration: 600 })`.
  - If none, keep default center/zoom; user can use Geolocate to center.

---

## Routing & UI Notes
- `src/routes/MapView.tsx` remains the container with tabs; only `MapHome` changes.
- Keep UI consistent with current dark theme (rounded cards, teal accents). Map can sit inside a card with ~60vh height.

---

## Implementation Steps
1. Install packages and set `VITE_MAPBOX_TOKEN`.
2. Add/confirm CSS for map container height; optionally import Mapbox CSS globally.
3. Create `src/lib/map.ts` with Firestore fetch + GeoJSON transform + bounds helpers.
4. Replace placeholder in `src/routes/MapHome.tsx` with a Mapbox map and lifecycle.
5. Add clustered source/layers, click handlers for clusters and points, and popups.
6. Fit bounds after data load; add nav and geolocate controls.
7. Test navigation across `/app/map`, `/app/map/list`, `/app/map/calendar`.
8. Configure `VITE_MAPBOX_TOKEN` in your host (e.g., Netlify) and rebuild.

---

## Open Questions
- Base style preference (Mapbox dark vs custom)?
- Startup with no points: default region vs prompt geolocation?
- Marker styling: simple circles vs custom sprite/HTML marker?
- Any embed-specific map behavior needed now or later?
