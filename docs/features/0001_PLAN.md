# Feature Plan 0001 — Back button on Event Detail + Bottom Nav restructure (Map/List/Calendar)

**Context:** The So Also PWA currently has separate tabs for **Map**, **List**, **Submit**, **Conferences**, and **Settings**. You asked to (a) **add a back button** to the Event Detail view, and (b) **change the bottom nav so the "Map" entry contains both the List and a new Calendar page**, resulting in a 4‑item bottom nav: **Map**, **Submit**, **Conferences**, **Settings**. This plan describes the precise technical changes needed, touching routes, components, and minor manifest/URL updates.

---

## Scope Summary
- Add a **Back** control on `/app/e/:slug` (**EventDetail**).
- Restructure navigation so **Map/List/Calendar** are accessed under a single **Map** tab.
- Add a new **Calendar** view (read-only, upcoming events grouped by day), fed by the same data source as List/Map.
- Update embeds and shortcuts to reflect the new structure.

---

## Files / Modules to Change or Create

### 1) Routing & Shell
- **`src/main.tsx`**
  - Replace separate `list` route with a nested or parameterized route under the **Map** area.
  - Add a route for the new **Calendar** view (e.g., `/app/map/calendar` or `/app/calendar` depending on final structure).
- **`src/AppShell.tsx`**
  - Update **Tabs()** to show **4 items**: Map, Submit, Conferences, Settings.
  - Ensure the Map tab points to a path that can switch between **Map / List / Calendar** (e.g., `/app/map` as the default sub-view with internal segment controls).

### 2) Views
- **Existing**
  - **`src/routes/MapView.tsx`**: Acts as the container for a segmented control to toggle **Map / List / Calendar**.
  - **`src/routes/ListView.tsx`**: Move under the Map area logically (no path change required if using local switching; otherwise, update route).
- **New**
  - **`src/routes/CalendarView.tsx`**: **Create** a read-only calendar list/grid view of upcoming items.
- **Embeds**
  - **`src/routes/EmbedView.tsx`**: Accept and handle `view=calendar` in addition to `view=map|list` and ensure consistent filtering.

### 3) Event detail back action
- **`src/routes/EventDetail.tsx`**
  - Add a **Back** button in the header area of the card.
  - Behavior: If `history.length > 1`, call `navigate(-1)`; otherwise `navigate('/app/map')` (fallback to the Map tab).

### 4) Manifest (optional, if you use shortcuts)
- **`public/app/manifest.json`**
  - Optionally update `shortcuts` to:
    - `{ name: "Browse", url: "/app/map" }` (single entry instead of separate Map/List)
    - Keep `Submit Event` and `Conferences` as-is.

### 5) Styles (if needed)
- **`styles/global.css`**
  - Add minimal styles for a segmented control (three buttons: Map, List, Calendar) inside the Map container.

---

## Behavioral Details & Algorithms

### A) Back button on Event Detail
1. In `EventDetail`, render a small back control (icon or text) near the top.
2. On click:
   - If `window.history.length > 1` (or using `useNavigationType`/`useNavigate`), call `navigate(-1)`.
   - Else, `navigate('/app/map')` to guarantee a sensible exit path even when opened from a share link.
3. No state persistence required; the Map/List/Calendar view restores based on URL or default.

### B) Map/List/Calendar restructure under Map tab
**Two viable patterns; pick one and apply consistently:**

**Pattern 1 — Single path with internal segment state**
- `/app/map` remains the only route for browsing. Inside `MapView`, render **three segment buttons**: "Map", "List", "Calendar".
- Maintain the active segment in the URL via `?mode=map|list|calendar`.
- On segment switch, update the query param and conditionally render:
  - Map container (existing placeholder)
  - List (reuse the existing `ListView` component content; either inline or extracted into a child component and imported)
  - Calendar (new `CalendarView` component)
- **Pros:** Single route; easy tab logic; embeds remain consistent (`/embed?view=...`).
- **Cons:** Slightly more conditional rendering inside one component.

**Pattern 2 — Nested routes under `/app/map/*`**
- Define:
  - `/app/map` → default to Map
  - `/app/map/list` → List
  - `/app/map/calendar` → Calendar
- The **Map tab** always links to `/app/map`; the segment buttons navigate to sub-routes.
- **Pros:** Clear URLs, React Router handles child rendering; better back/forward UX between the three views.
- **Cons:** Slightly more routing setup.

> **Recommendation:** Use **Pattern 2** (nested routes) for clearer URLs and browser history. It also mirrors how you’ll treat embeds (`/embed?view=map|list|calendar`).

### C) Calendar view algorithm (read-only)
Goal: Show **upcoming** items grouped by day with minimal DB reads.

1. **Data source**: same inputs as List — merge **approved one-off events** (`/events`) and **approved occurrences** (`/occurrences`), with `endUTC >= now`, ordered by `startUTC`.
2. **Fetch**:
   - Query `events`:
     - `where('status','==','approved')`
     - `where('endUTC','>=', nowISO)`
     - `orderBy('endUTC','asc')`
     - (optional) `limit(200)`
   - Query `occurrences` with the same filter/order/limit.
3. **Merge** results in-memory and **sort by `startUTC` asc`** (stable sort if both lists already suitably ordered).
4. **Group by day (local)**:
   - Convert `startUTC` to **local date** (e.g., `YYYY-MM-DD` in the user’s timezone).
   - Build a map: `date → [items]`.
5. **Render** per day in chronological order:
   - Day header (weekday, date)
   - For each item: time range (local), name, type, city/venue; optional chip for committee.
6. **Pagination/window** (optional):
   - Load events for next N days (e.g., 30). For larger windows, implement infinite scroll or month switches without changing the data algorithm above.
7. **Timezones**: Respect item fields; use `startUTC/endUTC` for ordering, but display using localized `startsAt` if provided; otherwise convert `startUTC` to local.
8. **Embeds**: Honor existing query params (e.g., `committee`, `range`) and apply the same filters before grouping.

### D) Embeds update
- `EmbedView.tsx` should accept `view=calendar` and render a calendar-focused layout when requested.
- Maintain existing params: `committee`, `view`, `range`.

---

## Type & Data Changes (No DB migrations required)
- **No new collections required** for the Calendar view; it reuses `events` and `occurrences`.
- Ensure items already have: `status`, `startUTC`, `endUTC`, `name`, `type`, and optional `committeeSlug`, `city`, `address`, `flyerUrl`.
- (Optional) Add `allDay: boolean` if you later need true all-day semantics; not required for MVP.

---

## Implementation Steps (Concise)

1. **Routing**
   - In `src/main.tsx`, add nested routes under `/app/map/*` for `list` and `calendar`; set index route to the existing map display.
   - Remove the top-level `/app/list` route.

2. **Bottom Nav**
   - In `src/AppShell.tsx → Tabs()`:
     - Change `tabs` array to: Map (`/app/map`), Submit (`/app/submit`), Conferences (`/app/conferences`), Settings (`/app/settings`).

3. **Map container**
   - In `src/routes/MapView.tsx`, add a small 3-way segmented control to navigate to `/app/map`, `/app/map/list`, `/app/map/calendar`.
   - Render the current child route (for Pattern 2) or conditionally render content (for Pattern 1).

4. **List view relocation**
   - If using nested routes, either:
     - Extract the JSX from `ListView.tsx` into a small child component and import it into the map area route, **or**
     - Keep `ListView.tsx` as-is and route to it under `/app/map/list`.

5. **Calendar view**
   - Create `src/routes/CalendarView.tsx`.
   - Implement the grouping logic described above (no schema changes needed).

6. **EventDetail back button**
   - In `src/routes/EventDetail.tsx`, add a back control.
   - Implement `navigate(-1)` with `/app/map` fallback.

7. **Embed support**
   - Update `src/routes/EmbedView.tsx` to accept `view=calendar` and render the correct mode.

8. **Manifest (optional)**
   - Update `public/app/manifest.json` `shortcuts` to consolidate browsing under a single Map entry if desired.

---

## Open Questions (answer before implementing if needed)
1. Preferred URL scheme for Calendar: `/app/map/calendar` (nested) **vs** query param `?mode=calendar`. (Plan assumes **nested**.)
2. Calendar rendering style: simple **agenda list** (grouped by day) vs. **month grid**. (Plan assumes **agenda** list.)
3. Embeds default: When `view` is omitted in `/embed`, should it default to `map`, `list`, or `calendar`?

> This plan reflects your exact request to **“add back button to event details view”** and **“change the map button so it has the list and a new calendar page on it so bottom nav will have map icon submit conferences and settings.”** It points to the precise files to update and the algorithms to use for the new Calendar view without requiring schema changes.
